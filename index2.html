<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´æœˆè¡¨ç¤ºå¯¾å¿œãƒ­ãƒ¼ãƒ³è¨ˆç®—æ©Ÿ</title>
    
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3QgeD0iMTIiIHk9IjgiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0OCIgcng9IjUiIGZpbGw9IiMyYzNlNTAiLz48cmVjdCB4PSIxOCIgeT0iMTYiIHdpZHRoPSIyOCIgaGVpZ2h0PSIxMiIgZmlsbD0iI2VjZjBmMSIvPjxjaXJjbGUgY3g9IjIyIiBjeT0iMzYiIHI9IjMiIGZpbGw9IiMzNDk4ZGIiLz48Y2lyY2xlIGN4PSIzMiIgY3k9IjM2IiByPSIzIiBmaWxsPSIjMzQ5OGRiIi8+PGNpcmNsZSBjeD0iNDIiIGN5PSIzNiIgcj0iMyIgZmlsbD0iIzM0OThkYiIvPjxjaXJjbGUgY3g9IjIyIiBjeT0iNDYiIHI9IjMiIGZpbGw9IiMzNDk4ZGIiLz48Y2lyY2xlIGN4PSIzMiIgY3k9IjQ2IiByPSIzIiBmaWxsPSIjMzQ5OGRiIi8+PGNpcmNsZSBjeD0iNDIiIGN5PSI0NiIgcj0iMyIgZmlsbD0iI2U3NGMzYyIvPjwvc3ZnPg==">

    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 1150px; /* å¹…ã‚’å¾®èª¿æ•´ */
        }
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .section-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-title.orange { color: #d35400; }
        .section-title.blue { color: #2980b9; }
        .section-title.green { color: #27ae60; }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        label { display: block; margin-bottom: 0.4rem; font-weight: bold; font-size: 0.85rem; color: #555; }
        input[type="number"], input[type="month"], select { 
            width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; 
        }
        
        .toggle-label { display: flex; align-items: center; cursor: pointer; font-size: 0.95rem; }
        .toggle-input { margin-right: 8px; transform: scale(1.3); accent-color: #d35400; }

        .dynamic-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; background: white; padding: 8px; border-radius: 5px; border: 1px solid #eee; }
        .dynamic-row input { padding: 8px; }
        .dynamic-row select { width: auto; padding: 8px; }
        .btn-add { background-color: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-remove { background-color: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }

        .calc-btn { width: 100%; padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: background 0.3s; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3); margin-top: 10px; }
        .calc-btn:hover { background-color: #2980b9; }

        /* çµæœã‚µãƒãƒªãƒ¼ã‚¨ãƒªã‚¢ */
        .summary-box {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            display: flex;
            justify-content: space-around;
            text-align: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .summary-item strong { display: block; font-size: 1.4rem; margin-bottom: 5px; color: #f1c40f; }

        .status-bar {
            background-color: #ffffff;
            border: 2px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .status-item { font-size: 1.1rem; font-weight: bold; }
        .status-value { font-size: 1.8rem; color: #e74c3c; margin: 0 5px; }
        .status-sub { font-size: 0.9rem; color: #666; margin-top: 5px; }

        .table-container { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 950px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; vertical-align: middle;}
        th { background-color: #ecf0f1; color: #2c3e50; text-align: center; font-weight: bold; white-space: nowrap; }
        
        .check-col { width: 40px; text-align: center; }
        .check-input { transform: scale(1.5); cursor: pointer; }
        
        tr.paid-row { background-color: #ecf0f1; color: #95a5a6; text-decoration: line-through; }
        tr.paid-row td { color: #95a5a6 !important; }

        .rate-changed-row { background-color: #ffeaa7 !important; }
        .prepayment-row { background-color: #d5f5e3 !important; }
        .year-total-row { background-color: #f7f9f9; font-weight: bold; border-top: 2px solid #bdc3c7; color: #7f8c8d; }
        
        .prepay-type-label { font-size: 0.75rem; display: inline-block; padding: 2px 4px; border-radius: 3px; color: white; margin-right: 5px; }
        .type-shorten { background-color: #e67e22; }
        .type-reduce { background-color: #27ae60; }
        .principal-balance-col { background-color: #fdfefe; font-weight: bold; color: #2c3e50; }
        
        /* å¹´æœˆè¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .date-cell { font-weight: bold; color: #2c3e50; }
        .count-sub { font-size: 0.75rem; color: #95a5a6; font-weight: normal; margin-left: 5px; }

    </style>
</head>
<body>

<div class="container">
    <h2><span style="font-size: 1.5rem;">ğŸ“Š</span> è©³ç´°ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>

    <div class="section-box">
        <div class="section-title">åŸºæœ¬è¨­å®š</div>
        <div class="input-grid">
            <div><label>å€Ÿå…¥å…ƒé‡‘ (å††)</label><input type="number" id="principal" value="30000000"></div>
            <div><label>å½“åˆé‡‘åˆ© (å¹´åˆ© %)</label><input type="number" id="initialRate" step="0.01" value="0.5"></div>
            <div><label>è¿”æ¸ˆæœŸé–“ (å¹´)</label><input type="number" id="years" value="35"></div>
            <div><label>è¿”æ¸ˆé–‹å§‹æœˆ</label><input type="month" id="startMonth"></div>
        </div>
    </div>

    <div class="section-box" style="border-left: 5px solid #d35400;">
        <div class="section-title orange">ğŸ”’ å½“åˆæœŸé–“å›ºå®šãƒ¢ãƒ¼ãƒ‰</div>
        <div style="margin-bottom:10px;">
            <label class="toggle-label">
                <input type="checkbox" id="useFixedMode" class="toggle-input" onchange="toggleFixedMode()">
                ã“ã®ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆæŒ‡å®šå¹´æ•°ã¾ã§å½“åˆé‡‘åˆ©ã€ãã®å¾Œå¤‰æ›´ï¼‰
            </label>
        </div>
        <div class="input-grid" id="fixedModeInputs" style="opacity: 0.5; pointer-events: none;">
            <div><label>å›ºå®šæœŸé–“ (å¹´)</label><input type="number" id="fixedYears" value="10" placeholder="10"></div>
            <div><label>æœŸé–“çµ‚äº†å¾Œã®é‡‘åˆ© (%)</label><input type="number" id="postFixedRate" step="0.01" value="1.5" placeholder="1.5"></div>
        </div>
    </div>

    <div class="section-box">
        <div class="section-title blue">
            ğŸ“ˆ è©³ç´°ãªé‡‘åˆ©å¤‰å‹• (æ‰‹å‹•è¿½åŠ )
            <button type="button" class="btn-add" onclick="addRateInput()">ï¼‹ è¿½åŠ </button>
        </div>
        <div id="rateInputsContainer"></div>
    </div>

    <div class="section-box">
        <div class="section-title green">
            ğŸ’° ç¹°ã‚Šä¸Šã’è¿”æ¸ˆè¨­å®š
            <button type="button" class="btn-add" onclick="addPrepayInput()">ï¼‹ è¿½åŠ </button>
        </div>
        <div id="prepayInputsContainer"></div>
    </div>

    <button class="calc-btn" onclick="calculateLoan()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>

    <div id="resultArea" style="display:none;">
        
        <div class="summary-box">
            <div class="summary-item"><span id="totalPaymentDisplay">0 å††</span><span>å½“åˆäºˆå®š ç·æ”¯æ‰•é¡</span></div>
            <div class="summary-item"><span id="totalInterestDisplay">0 å††</span><span>åˆ©æ¯ç·é¡</span></div>
            <div class="summary-item"><span id="actualMonthsDisplay">0 ãƒ¶æœˆ</span><span>å®Ÿè³ªè¿”æ¸ˆæœŸé–“</span></div>
        </div>

        <div class="status-bar" id="remainingStatus">
            <div class="status-item">
                æ®‹ã‚Šè¿”æ¸ˆå›æ•°ï¼šã‚ã¨ <span id="remainMonthsVal" class="status-value">0</span> ãƒ¶æœˆ
            </div>
            <div class="status-item" style="border-left: 1px solid #eee; padding-left: 20px;">
                æ®‹ã‚Šæ”¯æ‰•ç·é¡ï¼š <span id="remainAmountVal" style="font-size: 1.4rem; color:#333;">0</span> å††
                <div class="status-sub">ï¼ˆå…ƒé‡‘ï¼‹åˆ©æ¯ã®åˆè¨ˆï¼‰</div>
            </div>
        </div>
        <div style="text-align: right; font-size: 0.8rem; color: #7f8c8d; margin-top: 5px;">
            â€»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="check-col">æ¸ˆ</th>
                        <th>å¹´æœˆ</th> <th>é‡‘åˆ©</th>
                        <th>æœˆæ”¯æ‰•é¡</th>
                        <th>å†…) åˆ©æ¯</th>
                        <th>å†…) å…ƒé‡‘</th>
                        <th>ï¼‹ç¹°ã‚Šä¸Šã’</th>
                        <th style="font-size:0.8rem; line-height:1.2;">å…ƒé‡‘å……å½“å¾Œã®<br>å…ƒé‡‘æ®‹é¡</th>
                        <th>æ®‹é«˜</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€è¿”æ¸ˆé–‹å§‹æœˆã«ã€Œä»Šæœˆã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆ
    window.onload = function() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        document.getElementById('startMonth').value = `${yyyy}-${mm}`;
    };

    // --- UIåˆ¶å¾¡ ---
    function toggleFixedMode() {
        const isChecked = document.getElementById('useFixedMode').checked;
        const inputs = document.getElementById('fixedModeInputs');
        if (isChecked) { inputs.style.opacity = "1"; inputs.style.pointerEvents = "auto"; } 
        else { inputs.style.opacity = "0.5"; inputs.style.pointerEvents = "none"; }
    }

    function addRateInput() {
        const container = document.getElementById('rateInputsContainer');
        const div = document.createElement('div');
        div.className = 'dynamic-row';
        div.innerHTML = `<span>é–‹å§‹ã‹ã‚‰</span><input type="number" class="change-month-rate" placeholder="æœˆ" style="width:60px;"><span>ãƒ¶æœˆç›®ã«</span><input type="number" class="change-val-rate" step="0.01" placeholder="%" style="width:70px;"><span>% ã«</span><button class="btn-remove" onclick="this.parentElement.remove()">Ã—</button>`;
        container.appendChild(div);
    }

    function addPrepayInput() {
        const container = document.getElementById('prepayInputsContainer');
        const div = document.createElement('div');
        div.className = 'dynamic-row';
        div.innerHTML = `<span>é–‹å§‹ã‹ã‚‰</span><input type="number" class="change-month-prepay" placeholder="æœˆ" style="width:60px;"><span>ãƒ¶æœˆç›®ã«</span><input type="number" class="change-val-prepay" placeholder="å††" style="width:100px;"><span>å††ã‚’</span><select class="change-type-prepay"><option value="shorten">æœŸé–“çŸ­ç¸®å‹</option><option value="reduce">è¿”æ¸ˆé¡è»½æ¸›å‹</option></select><button class="btn-remove" onclick="this.parentElement.remove()">Ã—</button>`;
        container.appendChild(div);
    }

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    function calculateLoan() {
        const principalInput = parseFloat(document.getElementById('principal').value);
        const initialRateInput = parseFloat(document.getElementById('initialRate').value);
        const yearsInput = parseFloat(document.getElementById('years').value);
        const startMonthInput = document.getElementById('startMonth').value; // å¹´æœˆå–å¾—

        if (!principalInput || initialRateInput === "" || !yearsInput) {
            alert("åŸºæœ¬é …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // é–‹å§‹å¹´æœˆã®ãƒ‘ãƒ¼ã‚¹
        let startYear = 0;
        let startMonthIdx = 0; // 0-11
        if (startMonthInput) {
            const parts = startMonthInput.split('-');
            startYear = parseInt(parts[0]);
            startMonthIdx = parseInt(parts[1]) - 1;
        } else {
            // æœªå…¥åŠ›ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä»Šæ—¥ï¼‰
            const d = new Date();
            startYear = d.getFullYear();
            startMonthIdx = d.getMonth();
        }

        const rateChanges = {};
        if (document.getElementById('useFixedMode').checked) {
            const fixedYears = parseInt(document.getElementById('fixedYears').value);
            const postRate = parseFloat(document.getElementById('postFixedRate').value);
            if (fixedYears && !isNaN(postRate)) rateChanges[(fixedYears * 12) + 1] = postRate;
        }
        document.querySelectorAll('#rateInputsContainer .dynamic-row').forEach(row => {
            const m = parseInt(row.querySelector('.change-month-rate').value);
            const r = parseFloat(row.querySelector('.change-val-rate').value);
            if (m && !isNaN(r)) rateChanges[m] = r;
        });

        const prepayments = {};
        document.querySelectorAll('#prepayInputsContainer .dynamic-row').forEach(row => {
            const m = parseInt(row.querySelector('.change-month-prepay').value);
            const v = parseFloat(row.querySelector('.change-val-prepay').value);
            const type = row.querySelector('.change-type-prepay').value;
            if (m && v) prepayments[m] = { amount: v, type: type };
        });

        let currentBalance = principalInput;
        let currentRate = initialRateInput;
        let totalInterest = 0;
        let totalPayments = 0;
        const totalMonths = yearsInput * 12;
        
        let tableHTML = "";
        let yearlyPrincipal = 0, yearlyInterest = 0, yearlyPrepay = 0;
        let actualMonths = 0;

        let monthlyPayment = calculatePMT(currentBalance, currentRate, totalMonths);

        for (let i = 1; i <= totalMonths + 120; i++) {
            if (currentBalance <= 0) { actualMonths = i - 1; break; }

            // é‡‘åˆ©å¤‰å‹•
            let rateChanged = false;
            if (rateChanges[i] !== undefined) {
                currentRate = rateChanges[i];
                rateChanged = true;
                const remainingMonths = Math.max(1, totalMonths - i + 1);
                monthlyPayment = calculatePMT(currentBalance, currentRate, remainingMonths);
            }

            // ç¹°ã‚Šä¸Šã’
            let prepayAmount = 0;
            let prepayType = "";
            if (prepayments[i]) {
                prepayAmount = prepayments[i].amount;
                prepayType = prepayments[i].type;
                if (prepayAmount > currentBalance) prepayAmount = currentBalance;
            }

            const monthlyRate = (currentRate / 100) / 12;
            let interestPart = Math.floor(currentBalance * monthlyRate);
            let principalPart = monthlyPayment - interestPart;

            if (currentBalance <= principalPart + interestPart) {
                principalPart = currentBalance;
                monthlyPayment = principalPart + interestPart;
            }

            currentBalance -= principalPart;

            if (prepayAmount > 0) {
                currentBalance -= prepayAmount;
                if (currentBalance > 0 && prepayType === 'reduce') {
                    const remaining = Math.max(1, totalMonths - i);
                    monthlyPayment = calculatePMT(currentBalance, currentRate, remaining);
                } else if (currentBalance <= 0) {
                    currentBalance = 0;
                }
            }

            const thisMonthTotalPay = monthlyPayment + prepayAmount;

            totalInterest += interestPart;
            totalPayments += thisMonthTotalPay;
            yearlyPrincipal += principalPart;
            yearlyInterest += interestPart;
            yearlyPrepay += prepayAmount;

            let rowClass = "";
            let infoText = "-";
            
            if (prepayAmount > 0) {
                rowClass = "prepayment-row";
                const typeLabel = prepayType === 'shorten' ? `<span class="prepay-type-label type-shorten">çŸ­ç¸®</span>` : `<span class="prepay-type-label type-reduce">è»½æ¸›</span>`;
                infoText = typeLabel + `+${prepayAmount.toLocaleString()}`;
            } else if (rateChanged) {
                rowClass = "rate-changed-row";
            }

            // --- å¹´æœˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
            // i=1ã®ã¨ã startMonthIdx + 0
            const currentTotalMonthIdx = startMonthIdx + (i - 1);
            const calcYear = startYear + Math.floor(currentTotalMonthIdx / 12);
            const calcMonth = (currentTotalMonthIdx % 12) + 1;
            const dateStr = `${calcYear}å¹´${calcMonth}æœˆ`;

            // HTMLç”Ÿæˆ
            tableHTML += `
                <tr class="${rowClass}" id="row-${i}">
                    <td class="check-col">
                        <input type="checkbox" class="check-input" onchange="updateRemainingStatus(this, ${i})" data-pay="${thisMonthTotalPay}">
                    </td>
                    <td style="text-align:center;">
                        <span class="date-cell">${dateStr}</span>
                        <span class="count-sub">(${i})</span>
                    </td>
                    <td style="text-align:center;">${currentRate.toFixed(2)}%</td>
                    <td>${monthlyPayment.toLocaleString()}</td>
                    <td style="color:#e74c3c;">${interestPart.toLocaleString()}</td>
                    <td style="color:#2980b9;">${principalPart.toLocaleString()}</td>
                    <td style="text-align:center;">${infoText}</td>
                    <td class="principal-balance-col" style="text-align:right;">${Math.max(0, currentBalance).toLocaleString()}</td>
                    <td>${Math.max(0, currentBalance).toLocaleString()}</td>
                </tr>
            `;

            if (i % 12 === 0 || currentBalance === 0) {
                if(i % 12 === 0){
                     tableHTML += `
                        <tr class="year-total-row">
                            <td>-</td>
                            <td colspan="2" style="text-align:center;">${i/12}å¹´ç›®ã®åˆè¨ˆ</td>
                            <td>${(yearlyPrincipal+yearlyInterest).toLocaleString()}</td>
                            <td>${yearlyInterest.toLocaleString()}</td>
                            <td>${yearlyPrincipal.toLocaleString()}</td>
                            <td style="text-align:center; color:#27ae60;">${yearlyPrepay > 0 ? "+" + yearlyPrepay.toLocaleString() : "-"}</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    `;
                    yearlyPrincipal = 0; yearlyInterest = 0; yearlyPrepay = 0;
                }
            }
        }

        document.getElementById('totalPaymentDisplay').innerText = totalPayments.toLocaleString() + " å††";
        document.getElementById('totalInterestDisplay').innerText = totalInterest.toLocaleString() + " å††";
        document.getElementById('actualMonthsDisplay').innerText = actualMonths + " ãƒ¶æœˆ (" + (actualMonths/12).toFixed(1) + "å¹´)";
        document.getElementById('tableBody').innerHTML = tableHTML;
        
        document.getElementById('resultArea').style.display = 'block';
        updateRemainingStatus();
    }

    function calculatePMT(P, ratePercent, months) {
        if (P <= 0) return 0;
        if (ratePercent === 0) return Math.floor(P / months);
        const r = (ratePercent / 100) / 12;
        const pmt = P * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1);
        return Math.floor(pmt);
    }

    function updateRemainingStatus(checkbox, rowIndex) {
        if(checkbox) {
            const row = document.getElementById('row-' + rowIndex);
            if(checkbox.checked) { row.classList.add('paid-row'); } 
            else { row.classList.remove('paid-row'); }
        }

        const allChecks = document.querySelectorAll('.check-input');
        let remainingCount = 0;
        let remainingAmount = 0;

        allChecks.forEach(chk => {
            if (!chk.checked) {
                remainingCount++;
                remainingAmount += parseFloat(chk.getAttribute('data-pay')) || 0;
            }
        });

        document.getElementById('remainMonthsVal').innerText = remainingCount;
        document.getElementById('remainAmountVal').innerText = remainingAmount.toLocaleString();
    }
</script>

</body>
</html>